<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketMafia Pro: Advanced Crypto & Exchange Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .positive-change { color: #10b981; }
        .negative-change { color: #ef4444; }
        .neutral-change { color: #64748b; }
        .trust-score-high { color: #10b981; }
        .trust-score-medium { color: #f59e0b; }
        .trust-score-low { color: #ef4444; }
        .sparkline { width: 100px; height: 40px; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50">
    <header class="bg-white shadow-sm py-4 px-6 md:px-8">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">
                    <span class="bg-gradient-to-r from-blue-600 to-purple-600 text-transparent bg-clip-text">
                        MarketMafia Pro
                    </span>
                </h1>
                <span class="ml-2 px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full">BETA</span>
            </div>
            <div class="flex items-center space-x-4">
                <div id="globalStats" class="hidden md:flex space-x-6">
                    <div class="text-sm">
                        <span class="text-gray-500">Market Cap:</span>
                        <span id="totalMarketCap" class="ml-1 font-medium">$--</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-gray-500">24h Vol:</span>
                        <span id="totalVolume" class="ml-1 font-medium">$--</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-gray-500">BTC Dominance:</span>
                        <span id="btcDominance" class="ml-1 font-medium">--%</span>
                    </div>
                </div>
                <button id="refreshBtn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-6">
                <div class="flex space-x-2 mb-4 md:mb-0">
                    <button id="cryptoTabBtn" class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 bg-blue-600 text-white shadow-sm hover:bg-blue-700 focus:outline-none">
                        Cryptocurrencies
                    </button>
                    <button id="exchangeTabBtn" class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 bg-gray-100 text-gray-700 shadow-sm hover:bg-gray-200 focus:outline-none">
                        Exchanges
                    </button>
                    <button id="gainersTabBtn" class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 bg-gray-100 text-gray-700 shadow-sm hover:bg-gray-200 focus:outline-none">
                        Gainers & Losers
                    </button>
                    <button id="trendingTabBtn" class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 bg-gray-100 text-gray-700 shadow-sm hover:bg-gray-200 focus:outline-none">
                        Trending
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <select id="currencySelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="JPY">JPY</option>
                    </select>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search cryptocurrencies..."
                        class="text-sm p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 shadow-sm w-40 md:w-64"
                    />
                </div>
            </div>

            <div id="loadingIndicator" class="text-center text-gray-600 text-lg mb-4 hidden">
                <svg class="animate-spin h-8 w-8 text-blue-500 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading market data...
            </div>

            <div id="errorMessage" class="text-center text-red-600 text-lg mb-4 hidden">
                Failed to load data. Please try again later.
            </div>

            <div id="lastUpdated" class="text-right text-xs text-gray-500 mb-4 hidden">
                Last Updated: <span id="timestamp"></span> • Data from Binance, OKX, XT.com
            </div>

            <div id="cryptoSection" class="tab-content">
                <div class="overflow-x-auto rounded-lg border border-gray-200 table-container max-h-[70vh]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('rank')">#</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coin</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('price')">Price</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('change')">24h</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('volume')">Volume (24h)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('market_cap')">Market Cap</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">7d Chart</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exchanges</th>
                            </tr>
                        </thead>
                        <tbody id="cryptoTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-500">
                        Showing <span id="cryptoStart">1</span>-<span id="cryptoEnd">100</span> of <span id="cryptoTotal">--</span> coins
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50" disabled>Previous</button>
                        <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50" disabled>Next</button>
                    </div>
                </div>
            </div>

            <div id="exchangeSection" class="tab-content hidden">
                <div class="overflow-x-auto rounded-lg border border-gray-200 table-container max-h-[70vh]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exchange</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trust Score</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">24h Volume</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pairs</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Liquidity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fees</th>
                            </tr>
                        </thead>
                        <tbody id="exchangeTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="gainersSection" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Gainers (24h)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coin</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">24h Change</th>
                                    </tr>
                                </thead>
                                <tbody id="gainersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Losers (24h)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coin</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">24h Change</th>
                                    </tr>
                                </thead>
                                <tbody id="losersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="trendingSection" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Most Searched</h3>
                        <div class="space-y-3" id="mostSearchedList">
                            <!-- Data will be inserted here -->
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Highest Volume</h3>
                        <div class="space-y-3" id="highestVolumeList">
                            <!-- Data will be inserted here -->
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">New Listings</h3>
                        <div class="space-y-3" id="newListingsList">
                            <!-- Data will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Market Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Total Market Cap</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="overviewMarketCap">$--</p>
                    <p class="text-sm mt-1"><span id="marketCapChange" class="font-medium">--%</span> (24h)</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">24h Trading Volume</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="overviewVolume">$--</p>
                    <p class="text-sm mt-1"><span id="volumeChange" class="font-medium">--%</span> (24h)</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">BTC Dominance</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="overviewBTCDom">--%</p>
                    <p class="text-sm mt-1"><span id="btcDomChange" class="font-medium">--%</span> (24h)</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 px-6">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4">MarketMafia Pro</h3>
                    <p class="text-sm text-gray-400">The most advanced cryptocurrency and exchange tracking platform with real-time data from multiple sources.</p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase tracking-wider mb-4">Resources</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">API Documentation</a></li>
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Market Data</a></li>
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Research Reports</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase tracking-wider mb-4">Company</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">About Us</a></li>
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Careers</a></li>
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Press</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase tracking-wider mb-4">Legal</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Terms of Service</a></li>
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Privacy Policy</a></li>
                        <li><a href="#" class="text-sm text-gray-400 hover:text-white transition">Disclaimer</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-sm text-gray-400 text-center">
                <p>&copy; 2023 MarketMafia Pro. All rights reserved.</p>
                <p class="mt-2">Cryptocurrency data provided by Binance, OKX, and XT.com APIs</p>
            </div>
        </div>
    </footer>

    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold transition-colors duration-200">&times;</button>
            <div id="modalContent" class="py-4">
                <div id="modalLoading" class="text-center text-gray-600 text-lg mb-4">
                    <svg class="animate-spin h-8 w-8 text-blue-500 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading details...
                </div>
                <div id="modalError" class="text-center text-red-600 text-lg mb-4 hidden">
                    Failed to load details. Please try again.
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const elements = {
            loadingIndicator: document.getElementById('loadingIndicator'),
            errorMessage: document.getElementById('errorMessage'),
            lastUpdated: document.getElementById('lastUpdated'),
            timestamp: document.getElementById('timestamp'),
            searchInput: document.getElementById('searchInput'),
            currencySelect: document.getElementById('currencySelect'),
            refreshBtn: document.getElementById('refreshBtn'),
            globalStats: document.getElementById('globalStats'),
            totalMarketCap: document.getElementById('totalMarketCap'),
            totalVolume: document.getElementById('totalVolume'),
            btcDominance: document.getElementById('btcDominance'),
            overviewMarketCap: document.getElementById('overviewMarketCap'),
            overviewVolume: document.getElementById('overviewVolume'),
            overviewBTCDom: document.getElementById('overviewBTCDom'),
            marketCapChange: document.getElementById('marketCapChange'),
            volumeChange: document.getElementById('volumeChange'),
            btcDomChange: document.getElementById('btcDomChange'),
            cryptoStart: document.getElementById('cryptoStart'),
            cryptoEnd: document.getElementById('cryptoEnd'),
            cryptoTotal: document.getElementById('cryptoTotal'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            detailModal: document.getElementById('detailModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            modalContent: document.getElementById('modalContent'),
            modalLoading: document.getElementById('modalLoading'),
            modalError: document.getElementById('modalError')
        };

        // Tab elements
        const tabs = {
            cryptoTabBtn: document.getElementById('cryptoTabBtn'),
            exchangeTabBtn: document.getElementById('exchangeTabBtn'),
            gainersTabBtn: document.getElementById('gainersTabBtn'),
            trendingTabBtn: document.getElementById('trendingTabBtn'),
            cryptoSection: document.getElementById('cryptoSection'),
            exchangeSection: document.getElementById('exchangeSection'),
            gainersSection: document.getElementById('gainersSection'),
            trendingSection: document.getElementById('trendingSection')
        };

        // Table bodies
        const tableBodies = {
            crypto: document.getElementById('cryptoTableBody'),
            exchange: document.getElementById('exchangeTableBody'),
            gainers: document.getElementById('gainersTableBody'),
            losers: document.getElementById('losersTableBody'),
            mostSearched: document.getElementById('mostSearchedList'),
            highestVolume: document.getElementById('highestVolumeList'),
            newListings: document.getElementById('newListingsList')
        };

        // App state
        const state = {
            activeTab: 'crypto',
            currency: 'USD',
            cryptoData: [],
            exchangeData: [],
            gainersData: [],
            losersData: [],
            trendingData: {
                mostSearched: [],
                highestVolume: [],
                newListings: []
            },
            filteredCryptoData: [],
            currentPage: 1,
            itemsPerPage: 100,
            sortConfig: {
                key: 'market_cap',
                direction: 'desc'
            },
            exchangeRates: {
                USD: 1,
                EUR: 0.93,
                GBP: 0.80,
                JPY: 151.50
            },
            currencySymbols: {
                USD: '$',
                EUR: '€',
                GBP: '£',
                JPY: '¥'
            }
        };

        // Exchange API endpoints
        const API_ENDPOINTS = {
            BINANCE: 'https://api.binance.com/api/v3',
            OKX: 'https://www.okx.com/api/v5',
            XT: 'https://api.xt.com',
            COINGECKO: 'https://api.coingecko.com/api/v3'
        };

        // Initialize the app
        async function init() {
            setupEventListeners();
            await fetchExchangeRates();
            await fetchAllData();
            setInterval(fetchAllData, 60000); // Refresh every 60 seconds
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tab switching
            tabs.cryptoTabBtn.addEventListener('click', () => switchTab('crypto'));
            tabs.exchangeTabBtn.addEventListener('click', () => switchTab('exchange'));
            tabs.gainersTabBtn.addEventListener('click', () => switchTab('gainers'));
            tabs.trendingTabBtn.addEventListener('click', () => switchTab('trending'));

            // Search input
            elements.searchInput.addEventListener('input', () => {
                if (state.activeTab === 'crypto') {
                    filterCryptoData();
                }
            });

            // Currency selection
            elements.currencySelect.addEventListener('change', (e) => {
                state.currency = e.target.value;
                renderAllData();
            });

            // Refresh button
            elements.refreshBtn.addEventListener('click', fetchAllData);

            // Pagination
            elements.prevPageBtn.addEventListener('click', () => {
                if (state.currentPage > 1) {
                    state.currentPage--;
                    renderCryptoTable();
                }
            });

            elements.nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(state.filteredCryptoData.length / state.itemsPerPage);
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                    renderCryptoTable();
                }
            });

            // Modal close
            elements.closeModalBtn.addEventListener('click', () => {
                elements.detailModal.classList.add('hidden');
            });
        }

        // Switch between tabs
        function switchTab(tab) {
            state.activeTab = tab;
            
            // Update UI
            Object.values(tabs).forEach(t => t.classList.add('hidden'));
            tabs[`${tab}Section`].classList.remove('hidden');
            
            // Reset search placeholder
            switch(tab) {
                case 'crypto':
                    elements.searchInput.placeholder = 'Search cryptocurrencies...';
                    break;
                case 'exchange':
                    elements.searchInput.placeholder = 'Search exchanges...';
                    break;
                case 'gainers':
                case 'trending':
                    elements.searchInput.placeholder = 'Search...';
                    break;
            }
        }

        // Fetch all data from APIs
        async function fetchAllData() {
            try {
                elements.loadingIndicator.classList.remove('hidden');
                elements.errorMessage.classList.add('hidden');
                
                // Fetch data from multiple sources in parallel
                await Promise.all([
                    fetchCryptoData(),
                    fetchExchangeData(),
                    fetchGainersLosersData(),
                    fetchTrendingData()
                ]);
                
                updateTimestamp();
                renderAllData();
            } catch (error) {
                console.error('Error fetching data:', error);
                elements.errorMessage.classList.remove('hidden');
            } finally {
                elements.loadingIndicator.classList.add('hidden');
            }
        }

        // Fetch cryptocurrency data from Binance, OKX, and XT
        async function fetchCryptoData() {
            try {
                // Get top 100 coins by market cap from CoinGecko as a base
                const geckoResponse = await fetch(`${API_ENDPOINTS.COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=true&price_change_percentage=24h`);
                const geckoData = await geckoResponse.json();
                
                // Enhance with data from exchanges
                const enhancedData = await Promise.all(geckoData.map(async (coin) => {
                    // Get prices from exchanges
                    const [binancePrice, okxPrice, xtPrice] = await Promise.all([
                        getExchangePrice(coin.symbol.toUpperCase(), 'BINANCE'),
                        getExchangePrice(coin.symbol.toUpperCase(), 'OKX'),
                        getExchangePrice(coin.symbol.toUpperCase(), 'XT')
                    ]);
                    
                    // Calculate average price
                    const prices = [binancePrice, okxPrice, xtPrice].filter(p => p !== null);
                    const avgPrice = prices.length > 0 ? prices.reduce((sum, p) => sum + p, 0) / prices.length : coin.current_price;
                    
                    return {
                        ...coin,
                        id: coin.id,
                        symbol: coin.symbol.toUpperCase(),
                        current_price: avgPrice,
                        exchanges: {
                            binance: binancePrice,
                            okx: okxPrice,
                            xt: xtPrice
                        },
                        price_change_percentage_24h: coin.price_change_percentage_24h || 0
                    };
                });
                
                state.cryptoData = enhancedData;
                state.filteredCryptoData = [...enhancedData];
                
                // Calculate global stats
                calculateGlobalStats();
            } catch (error) {
                console.error('Error fetching crypto data:', error);
                throw error;
            }
        }

        // Get price from a specific exchange
        async function getExchangePrice(symbol, exchange) {
            try {
                let price = null;
                
                switch(exchange) {
                    case 'BINANCE':
                        // Binance uses BTC, ETH, BNB, USDT, etc. as quote currencies
                        const binanceResponse = await fetch(`${API_ENDPOINTS.BINANCE}/ticker/price?symbol=${symbol}USDT`);
                        const binanceData = await binanceResponse.json();
                        price = parseFloat(binanceData.price);
                        break;
                        
                    case 'OKX':
                        // OKX uses similar format but with dash: BTC-USDT
                        const okxResponse = await fetch(`${API_ENDPOINTS.OKX}/market/ticker?instId=${symbol}-USDT`);
                        const okxData = await okxResponse.json();
                        if (okxData.data && okxData.data.length > 0) {
                            price = parseFloat(okxData.data[0].last);
                        }
                        break;
                        
                    case 'XT':
                        // XT.com uses slash: BTC/USDT
                        const xtResponse = await fetch(`${API_ENDPOINTS.XT}/trade/api/v1/getTicker?symbol=${symbol.toLowerCase()}_usdt`);
                        const xtData = await xtResponse.json();
                        if (xtData.result && xtData.ticker) {
                            price = parseFloat(xtData.ticker.last);
                        }
                        break;
                }
                
                return price;
            } catch (error) {
                console.error(`Error getting price from ${exchange} for ${symbol}:`, error);
                return null;
            }
        }

        // Fetch exchange data
        async function fetchExchangeData() {
            // Simulated exchange data (in a real app, you'd fetch from exchange APIs)
            state.exchangeData = [
                {
                    id: 'binance',
                    name: 'Binance',
                    trust_score: 10,
                    volume_24h_usd: 15000000000,
                    pairs: 1500,
                    liquidity: 'Very High',
                    fees: '0.1%',
                    url: 'https://www.binance.com'
                },
                {
                    id: 'okx',
                    name: 'OKX',
                    trust_score: 9,
                    volume_24h_usd: 5000000000,
                    pairs: 800,
                    liquidity: 'High',
                    fees: '0.08% - 0.1%',
                    url: 'https://www.okx.com'
                },
                {
                    id: 'xt',
                    name: 'XT.com',
                    trust_score: 8,
                    volume_24h_usd: 3000000000,
                    pairs: 600,
                    liquidity: 'Medium',
                    fees: '0.1% - 0.2%',
                    url: 'https://www.xt.com'
                },
                {
                    id: 'kraken',
                    name: 'Kraken',
                    trust_score: 9,
                    volume_24h_usd: 4000000000,
                    pairs: 700,
                    liquidity: 'High',
                    fees: '0.16% - 0.26%',
                    url: 'https://www.kraken.com'
                },
                {
                    id: 'huobi',
                    name: 'Huobi',
                    trust_score: 8,
                    volume_24h_usd: 2500000000,
                    pairs: 900,
                    liquidity: 'Medium',
                    fees: '0.2%',
                    url: 'https://www.huobi.com'
                }
            ];
        }

        // Fetch gainers and losers data
        async function fetchGainersLosersData() {
            // Get top gainers and losers from CoinGecko
            const response = await fetch(`${API_ENDPOINTS.COINGECKO}/coins/markets?vs_currency=usd&order=gecko_desc&per_page=20&page=1&sparkline=false&price_change_percentage=24h`);
            const data = await response.json();
            
            // Separate into gainers and losers
            state.gainersData = data
                .filter(coin => coin.price_change_percentage_24h > 0)
                .sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h)
                .slice(0, 10);
                
            state.losersData = data
                .filter(coin => coin.price_change_percentage_24h < 0)
                .sort((a, b) => a.price_change_percentage_24h - b.price_change_percentage_24h)
                .slice(0, 10);
        }

        // Fetch trending data
        async function fetchTrendingData() {
            // Get trending coins from CoinGecko
            const response = await fetch(`${API_ENDPOINTS.COINGECKO}/search/trending`);
            const data = await response.json();
            
            state.trendingData = {
                mostSearched: data.coins.slice(0, 5).map(coin => coin.item),
                highestVolume: [...state.cryptoData]
                    .sort((a, b) => b.total_volume - a.total_volume)
                    .slice(0, 5),
                newListings: [...state.cryptoData]
                    .sort((a, b) => new Date(b.ath_date) - new Date(a.ath_date))
                    .slice(0, 5)
            };
        }

        // Fetch exchange rates for currency conversion
        async function fetchExchangeRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                state.exchangeRates = data.rates;
            } catch (error) {
                console.error('Error fetching exchange rates, using defaults:', error);
                // Use default rates if API fails
                state.exchangeRates = {
                    USD: 1,
                    EUR: 0.93,
                    GBP: 0.80,
                    JPY: 151.50
                };
            }
        }

        // Calculate global market statistics
        function calculateGlobalStats() {
            const totalMarketCap = state.cryptoData.reduce((sum, coin) => sum + coin.market_cap, 0);
            const totalVolume = state.cryptoData.reduce((sum, coin) => sum + coin.total_volume, 0);
            const btcMarketCap = state.cryptoData.find(coin => coin.symbol === 'BTC')?.market_cap || 0;
            const btcDominance = (btcMarketCap / totalMarketCap) * 100;
            
            // Update global stats
            elements.totalMarketCap.textContent = formatCurrency(totalMarketCap, 'USD');
            elements.totalVolume.textContent = formatCurrency(totalVolume, 'USD');
            elements.btcDominance.textContent = btcDominance.toFixed(2) + '%';
            
            // Update overview stats
            elements.overviewMarketCap.textContent = formatCurrency(totalMarketCap, state.currency);
            elements.overviewVolume.textContent = formatCurrency(totalVolume, state.currency);
            elements.overviewBTCDom.textContent = btcDominance.toFixed(2) + '%';
            
            // Show global stats
            elements.globalStats.classList.remove('hidden');
        }

        // Filter crypto data based on search input
        function filterCryptoData() {
            const searchTerm = elements.searchInput.value.toLowerCase();
            state.filteredCryptoData = state.cryptoData.filter(coin => 
                coin.name.toLowerCase().includes(searchTerm) || 
                coin.symbol.toLowerCase().includes(searchTerm)
            );
            state.currentPage = 1;
            renderCryptoTable();
        }

        // Sort table data
        function sortTable(key) {
            // If same key, reverse direction; else set new key and default direction
            if (state.sortConfig.key === key) {
                state.sortConfig.direction = state.sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortConfig.key = key;
                state.sortConfig.direction = 'desc';
            }
            
            state.filteredCryptoData.sort((a, b) => {
                // Handle different data types
                let valueA, valueB;
                
                switch(key) {
                    case 'rank':
                        valueA = a.market_cap_rank;
                        valueB = b.market_cap_rank;
                        break;
                    case 'price':
                        valueA = a.current_price;
                        valueB = b.current_price;
                        break;
                    case 'change':
                        valueA = a.price_change_percentage_24h;
                        valueB = b.price_change_percentage_24h;
                        break;
                    case 'volume':
                        valueA = a.total_volume;
                        valueB = b.total_volume;
                        break;
                    case 'market_cap':
                    default:
                        valueA = a.market_cap;
                        valueB = b.market_cap;
                        break;
                }
                
                if (valueA < valueB) {
                    return state.sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return state.sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            renderCryptoTable();
        }

        // Render all data based on current state
        function renderAllData() {
            switch(state.activeTab) {
                case 'crypto':
                    renderCryptoTable();
                    break;
                case 'exchange':
                    renderExchangeTable();
                    break;
                case 'gainers':
                    renderGainersLosersTable();
                    break;
                case 'trending':
                    renderTrendingData();
                    break;
            }
        }

        // Render cryptocurrency table
        function renderCryptoTable() {
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const paginatedData = state.filteredCryptoData.slice(startIndex, endIndex);
            
            tableBodies.crypto.innerHTML = '';
            
            if (paginatedData.length === 0) {
                tableBodies.crypto.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-4 text-center text-gray-500">
                            No cryptocurrencies found. Try a different search term.
                        </td>
                    </tr>
                `;
                return;
            }
            
            paginatedData.forEach((coin, index) => {
                const globalIndex = startIndex + index + 1;
                const priceChangeClass = coin.price_change_percentage_24h >= 0 ? 
                    'positive-change' : 'negative-change';
                
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.dataset.id = coin.id;
                row.dataset.type = 'crypto';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${globalIndex}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="${coin.image}" alt="${coin.name}" class="w-6 h-6 rounded-full mr-3">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${coin.name}</div>
                                <div class="text-xs text-gray-500">${coin.symbol}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${formatCurrency(coin.current_price, state.currency)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${priceChangeClass}">
                        ${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(2) + '%' : 'N/A'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${formatCurrency(coin.total_volume, state.currency)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${formatCurrency(coin.market_cap, state.currency)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="sparkline" id="sparkline-${coin.id}"></div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex space-x-1">
                            ${coin.exchanges.binance ? '<span class="text-xs px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-800">BNB</span>' : ''}
                            ${coin.exchanges.okx ? '<span class="text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-800">OKX</span>' : ''}
                            ${coin.exchanges.xt ? '<span class="text-xs px-1.5 py-0.5 rounded bg-purple-100 text-purple-800">XT</span>' : ''}
                        </div>
                    </td>
                `;
                
                tableBodies.crypto.appendChild(row);
                
                // Add click listener for details
                row.addEventListener('click', () => showCoinDetails(coin.id));
                
                // Render sparkline if data is available
                if (coin.sparkline_in_7d && coin.sparkline_in_7d.price) {
                    renderSparkline(`sparkline-${coin.id}`, coin.sparkline_in_7d.price);
                }
            });
            
            // Update pagination info
            elements.cryptoStart.textContent = startIndex + 1;
            elements.cryptoEnd.textContent = Math.min(endIndex, state.filteredCryptoData.length);
            elements.cryptoTotal.textContent = state.filteredCryptoData.length;
            
            // Update pagination buttons
            elements.prevPageBtn.disabled = state.currentPage === 1;
            elements.nextPageBtn.disabled = endIndex >= state.filteredCryptoData.length;
        }

        // Render exchange table
        function renderExchangeTable() {
            tableBodies.exchange.innerHTML = '';
            
            state.exchangeData.forEach((exchange, index) => {
                const trustScoreClass = exchange.trust_score >= 9 ? 'trust-score-high' : 
                                      exchange.trust_score >= 7 ? 'trust-score-medium' : 'trust-score-low';
                
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.dataset.id = exchange.id;
                row.dataset.type = 'exchange';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${index + 1}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${exchange.name}</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="text-sm font-medium ${trustScoreClass}">${exchange.trust_score}</span>
                        <span class="text-xs text-gray-500">/10</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${formatCurrency(exchange.volume_24h_usd, state.currency)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${exchange.pairs.toLocaleString()}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${exchange.liquidity}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${exchange.fees}
                    </td>
                `;
                
                tableBodies.exchange.appendChild(row);
                row.addEventListener('click', () => showExchangeDetails(exchange.id));
            });
        }

        // Render gainers and losers tables
        function renderGainersLosersTable() {
            // Gainers table
            tableBodies.gainers.innerHTML = '';
            state.gainersData.forEach(coin => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.dataset.id = coin.id;
                row.dataset.type = 'crypto';
                
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="${coin.image}" alt="${coin.name}" class="w-5 h-5 rounded-full mr-2">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${coin.name}</div>
                                <div class="text-xs text-gray-500">${coin.symbol.toUpperCase()}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                        ${formatCurrency(coin.current_price, state.currency)}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium positive-change">
                        +${coin.price_change_percentage_24h.toFixed(2)}%
                    </td>
                `;
                
                tableBodies.gainers.appendChild(row);
                row.addEventListener('click', () => showCoinDetails(coin.id));
            });
            
            // Losers table
            tableBodies.losers.innerHTML = '';
            state.losersData.forEach(coin => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.dataset.id = coin.id;
                row.dataset.type = 'crypto';
                
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="${coin.image}" alt="${coin.name}" class="w-5 h-5 rounded-full mr-2">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${coin.name}</div>
                                <div class="text-xs text-gray-500">${coin.symbol.toUpperCase()}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                        ${formatCurrency(coin.current_price, state.currency)}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium negative-change">
                        ${coin.price_change_percentage_24h.toFixed(2)}%
                    </td>
                `;
                
                tableBodies.losers.appendChild(row);
                row.addEventListener('click', () => showCoinDetails(coin.id));
            });
        }

        // Render trending data
        function renderTrendingData() {
            // Most searched
            tableBodies.mostSearched.innerHTML = '';
            state.trendingData.mostSearched.forEach(coin => {
                const item = document.createElement('div');
                item.classList.add('flex', 'items-center', 'justify-between', 'hover:bg-gray-50', 'p-2', 'rounded', 'cursor-pointer');
                item.dataset.id = coin.id;
                item.dataset.type = 'crypto';
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <img src="${coin.thumb}" alt="${coin.name}" class="w-6 h-6 rounded-full mr-3">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${coin.name}</div>
                            <div class="text-xs text-gray-500">${coin.symbol.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                        Hot
                    </div>
                `;
                
                tableBodies.mostSearched.appendChild(item);
                item.addEventListener('click', () => showCoinDetails(coin.id));
            });
            
            // Highest volume
            tableBodies.highestVolume.innerHTML = '';
            state.trendingData.highestVolume.forEach(coin => {
                const item = document.createElement('div');
                item.classList.add('flex', 'items-center', 'justify-between', 'hover:bg-gray-50', 'p-2', 'rounded', 'cursor-pointer');
                item.dataset.id = coin.id;
                item.dataset.type = 'crypto';
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <img src="${coin.image}" alt="${coin.name}" class="w-6 h-6 rounded-full mr-3">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${coin.name}</div>
                            <div class="text-xs text-gray-500">${coin.symbol.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${formatCurrency(coin.total_volume, state.currency)}
                    </div>
                `;
                
                tableBodies.highestVolume.appendChild(item);
                item.addEventListener('click', () => showCoinDetails(coin.id));
            });
            
            // New listings
            tableBodies.newListings.innerHTML = '';
            state.trendingData.newListings.forEach(coin => {
                const item = document.createElement('div');
                item.classList.add('flex', 'items-center', 'justify-between', 'hover:bg-gray-50', 'p-2', 'rounded', 'cursor-pointer');
                item.dataset.id = coin.id;
                item.dataset.type = 'crypto';
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <img src="${coin.image}" alt="${coin.name}" class="w-6 h-6 rounded-full mr-3">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${coin.name}</div>
                            <div class="text-xs text-gray-500">${coin.symbol.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        New
                    </div>
                `;
                
                tableBodies.newListings.appendChild(item);
                item.addEventListener('click', () => showCoinDetails(coin.id));
            });
        }

        // Render sparkline chart
        function renderSparkline(elementId, prices) {
            const ctx = document.getElementById(elementId);
            if (!ctx) return;
            
            // Clear previous canvas if exists
            if (ctx.tagName === 'CANVAS') {
                ctx.remove();
                const newCanvas = document.createElement('canvas');
                newCanvas.id = elementId;
                newCanvas.classList.add('sparkline');
                document.querySelector(`#${elementId}`).parentNode.appendChild(newCanvas);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(prices.length).fill(''),
                    datasets: [{
                        data: prices,
                        borderColor: prices[prices.length - 1] >= prices[0] ? '#10b981' : '#ef4444',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    }
                }
            });
        }

        // Show coin details in modal
        async function showCoinDetails(coinId) {
            elements.detailModal.classList.remove('hidden');
            elements.modalLoading.classList.remove('hidden');
            elements.modalError.classList.add('hidden');
            elements.modalContent.innerHTML = '';
            
            try {
                // Find the coin in our data
                const coin = state.cryptoData.find(c => c.id === coinId);
                if (!coin) throw new Error('Coin not found');
                
                // Fetch additional details from CoinGecko
                const detailsResponse = await fetch(`${API_ENDPOINTS.COINGECKO}/coins/${coinId}`);
                const details = await detailsResponse.json();
                
                // Fetch historical data for chart
                const historyResponse = await fetch(`${API_ENDPOINTS.COINGECKO}/coins/${coinId}/market_chart?vs_currency=usd&days=30`);
                const historyData = await historyResponse.json();
                
                // Prepare data for rendering
                const priceData = historyData.prices.map(item => ({
                    date: new Date(item[0]),
                    price: item[1]
                }));
                
                const volumeData = historyData.total_volumes.map(item => ({
                    date: new Date(item[0]),
                    volume: item[1]
                }));
                
                // Format HTML
                const priceChange24hClass = coin.price_change_percentage_24h >= 0 ? 'positive-change' : 'negative-change';
                const priceChange7dClass = details.market_data.price_change_percentage_7d >= 0 ? 'positive-change' : 'negative-change';
                const priceChange30dClass = details.market_data.price_change_percentage_30d >= 0 ? 'positive-change' : 'negative-change';
                
                let html = `
                    <div class="flex flex-col md:flex-row md:items-start mb-6">
                        <div class="flex items-center mb-4 md:mb-0 md:mr-6">
                            <img src="${coin.image}" alt="${coin.name}" class="w-16 h-16 rounded-full mr-4 shadow-md">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">${coin.name} (${coin.symbol.toUpperCase()})</h2>
                                <p class="text-xl font-semibold text-gray-800">${formatCurrency(coin.current_price, state.currency)}</p>
                                <p class="text-sm ${priceChange24hClass}">
                                    ${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(2) + '%' : 'N/A'} (24h)
                                </p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-gray-500">Market Cap</p>
                                <p class="font-medium">${formatCurrency(coin.market_cap, state.currency)}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-gray-500">24h Volume</p>
                                <p class="font-medium">${formatCurrency(coin.total_volume, state.currency)}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-gray-500">Circulating Supply</p>
                                <p class="font-medium">${formatNumber(coin.circulating_supply)} ${coin.symbol.toUpperCase()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="h-64">
                            <canvas id="coinPriceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Price Performance</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">7d Change</span>
                                    <span class="${priceChange7dClass} font-medium">
                                        ${details.market_data.price_change_percentage_7d ? details.market_data.price_change_percentage_7d.toFixed(2) + '%' : 'N/A'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">30d Change</span>
                                    <span class="${priceChange30dClass} font-medium">
                                        ${details.market_data.price_change_percentage_30d ? details.market_data.price_change_percentage_30d.toFixed(2) + '%' : 'N/A'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">All-Time High</span>
                                    <span class="font-medium">
                                        ${formatCurrency(details.market_data.ath.usd, state.currency)}
                                        <span class="text-xs text-gray-500">
                                            ${new Date(details.market_data.ath_date.usd).toLocaleDateString()}
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Market Data</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Trading Volume (24h)</span>
                                    <span class="font-medium">${formatCurrency(details.market_data.total_volume.usd, state.currency)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Market Cap Rank</span>
                                    <span class="font-medium">#${coin.market_cap_rank || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Available on</span>
                                    <div class="flex space-x-1">
                                        ${coin.exchanges.binance ? '<span class="text-xs px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-800">BNB</span>' : ''}
                                        ${coin.exchanges.okx ? '<span class="text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-800">OKX</span>' : ''}
                                        ${coin.exchanges.xt ? '<span class="text-xs px-1.5 py-0.5 rounded bg-purple-100 text-purple-800">XT</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">About ${coin.name}</h3>
                        <p class="text-gray-700">${details.description?.en || 'No description available.'}</p>
                    </div>
                `;
                
                elements.modalContent.innerHTML = html;
                elements.modalLoading.classList.add('hidden');
                
                // Render price chart
                renderCoinPriceChart(priceData);
                
            } catch (error) {
                console.error('Error showing coin details:', error);
                elements.modalLoading.classList.add('hidden');
                elements.modalError.classList.remove('hidden');
            }
        }

        // Show exchange details in modal
        async function showExchangeDetails(exchangeId) {
            elements.detailModal.classList.remove('hidden');
            elements.modalLoading.classList.remove('hidden');
            elements.modalError.classList.add('hidden');
            elements.modalContent.innerHTML = '';
            
            try {
                const exchange = state.exchangeData.find(e => e.id === exchangeId);
                if (!exchange) throw new Error('Exchange not found');
                
                // Simulate fetching additional data
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const html = `
                    <div class="flex flex-col md:flex-row md:items-start mb-6">
                        <div class="flex items-center mb-4 md:mb-0 md:mr-6">
                            <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-2xl font-bold text-gray-600 mr-4">
                                ${exchange.name.charAt(0)}
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">${exchange.name}</h2>
                                <p class="text-gray-600">${exchange.url}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-gray-500">Trust Score</p>
                                <p class="font-medium">${exchange.trust_score}/10</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-gray-500">24h Volume</p>
                                <p class="font-medium">${formatCurrency(exchange.volume_24h_usd, state.currency)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Key Information</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Trading Pairs</span>
                                    <span class="font-medium">${exchange.pairs.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Liquidity</span>
                                    <span class="font-medium">${exchange.liquidity}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Trading Fees</span>
                                    <span class="font-medium">${exchange.fees}</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Top Traded Pairs</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">BTC/USDT</span>
                                    <span class="font-medium">${formatCurrency(exchange.volume_24h_usd * 0.3, state.currency)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ETH/USDT</span>
                                    <span class="font-medium">${formatCurrency(exchange.volume_24h_usd * 0.2, state.currency)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">SOL/USDT</span>
                                    <span class="font-medium">${formatCurrency(exchange.volume_24h_usd * 0.1, state.currency)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">About ${exchange.name}</h3>
                        <p class="text-gray-700">
                            ${exchange.name} is one of the leading cryptocurrency exchanges with a focus on providing 
                            high liquidity and low trading fees. It supports a wide range of cryptocurrencies 
                            and trading pairs, catering to both retail and institutional investors.
                        </p>
                    </div>
                `;
                
                elements.modalContent.innerHTML = html;
                elements.modalLoading.classList.add('hidden');
                
            } catch (error) {
                console.error('Error showing exchange details:', error);
                elements.modalLoading.classList.add('hidden');
                elements.modalError.classList.remove('hidden');
            }
        }

        // Render coin price chart in modal
        function renderCoinPriceChart(priceData) {
            const ctx = document.getElementById('coinPriceChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: priceData.map(item => item.date.toLocaleDateString()),
                    datasets: [{
                        label: 'Price',
                        data: priceData.map(item => item.price),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${state.currencySymbols[state.currency]}${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return `${state.currencySymbols[state.currency]}${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Format currency with proper symbol and decimal places
        function formatCurrency(amount, currency) {
            if (amount === undefined || amount === null) return 'N/A';
            
            const rate = state.exchangeRates[currency] || 1;
            const convertedAmount = amount * rate;
            const symbol = state.currencySymbols[currency] || '';
            
            if (convertedAmount >= 1000000000) {
                return `${symbol}${(convertedAmount / 1000000000).toFixed(2)}B`;
            } else if (convertedAmount >= 1000000) {
                return `${symbol}${(convertedAmount / 1000000).toFixed(2)}M`;
            } else if (convertedAmount >= 1000) {
                return `${symbol}${(convertedAmount / 1000).toFixed(2)}K`;
            } else if (convertedAmount >= 1) {
                return `${symbol}${convertedAmount.toFixed(2)}`;
            } else {
                return `${symbol}${convertedAmount.toFixed(6)}`;
            }
        }

        // Format large numbers
        function formatNumber(num) {
            if (num === undefined || num === null) return 'N/A';
            
            if (num >= 1000000000) {
                return `${(num / 1000000000).toFixed(2)}B`;
            } else if (num >= 1000000) {
                return `${(num / 1000000).toFixed(2)}M`;
            } else if (num >= 1000) {
                return `${(num / 1000).toFixed(2)}K`;
            } else {
                return num.toLocaleString();
            }
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            elements.timestamp.textContent = now.toLocaleTimeString();
            elements.lastUpdated.classList.remove('hidden');
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
